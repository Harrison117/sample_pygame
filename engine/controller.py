import pygame
from pygame.locals import *

from helper.helper import WeakBoundMethod
from util.enums import *
from event import *


class KeyboardController(Listener):
    """KeyboardController takes Pygame events generated by the
    keyboard and uses them to control the model, by sending Requests
    or to control the Pygame display directly, as with the QuitEvent
    """
    def __init__(self, event_mgr):
        super(KeyboardController, self).__init__(
            event_mgr=event_mgr)
        self._event_mgr.add(TickEvent, WeakBoundMethod(self.on_tick_event))

    def on_tick_event(self, e):
        for pygame_event in pygame.event.get():
            event = None
            if pygame_event.type == QUIT or (pygame_event.type == KEYDOWN and pygame_event.key == K_ESCAPE):
                event = QuitEvent()
            elif pygame_event.type == KEYDOWN:
                if pygame_event.key == K_LEFT:
                    event = InputMoveEvent(
                        direction=LEFT, magnitude=LEFT_MAGNITUDE, is_player=True)
                elif pygame_event.key == K_RIGHT:
                    event = InputMoveEvent(
                        direction=RIGHT, magnitude=RIGHT_MAGNITUDE, is_player=True)
                elif pygame_event.key == K_UP:
                    event = InputMoveEvent(
                        direction=UP, magnitude=UP_MAGNITUDE, is_player=True)
                elif pygame_event.key == K_DOWN:
                    event = InputMoveEvent(
                        direction=DOWN, magnitude=DOWN_MAGNITUDE, is_player=True)
                elif pygame_event.key == K_SPACE:
                    pass

            elif pygame_event.type == KEYUP:
                if pygame_event.key == K_LEFT:
                    event = InputMoveEvent(
                        direction=LEFT, magnitude=STOP, is_player=True)
                elif pygame_event.key == K_RIGHT:
                    event = InputMoveEvent(
                        direction=RIGHT, magnitude=STOP, is_player=True)
                elif pygame_event.key == K_UP:
                    event = InputMoveEvent(
                        direction=UP, magnitude=STOP, is_player=True)
                elif pygame_event.key == K_DOWN:
                    event = InputMoveEvent(
                        direction=DOWN, magnitude=STOP, is_player=True)
                elif pygame_event.key == K_SPACE:
                    pass

            if event:
                # print(f'Event {event.__class__.__name__} sent! Data: {event.get_data()}')
                self._event_mgr.post(event)


class CPUSpinnerController(Listener):
    def __init__(self, event_mgr):
        super(CPUSpinnerController, self).__init__(
            event_mgr=event_mgr)
        self.running = True
        self._clock = pygame.time.Clock()
        self._milliseconds = 0

        self._event_mgr.add(QuitEvent, WeakBoundMethod(self.on_quit_event))

    def run(self):
        while self.running:
            self._event_mgr.post(TickEvent())
            self._milliseconds = self._clock.tick(60)

    def on_quit_event(self, event):
        self.running = False
